generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String?
  nickname     String
  role         Role     @default(PLAYER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  createdRooms   Room[]           @relation("RoomHost")
  playerSessions PlayerSession[]
  submissions    Submission[]
  votes          Vote[]
}

enum Role {
  PLAYER
  ADMIN
  MODERATOR
}

model Room {
  id           String    @id @default(cuid())
  code         String    @unique
  type         RoomType  @default(PRIVATE)
  hostId       String
  currentState GameState @default(LOBBY)
  currentRound Int       @default(0)
  maxPlayers   Int       @default(8)
  minPlayers   Int       @default(3)
  numRounds    Int       @default(5)
  writeTimer   Int       @default(90)
  voteTimer    Int       @default(30)
  startedAt    DateTime?
  endedAt      DateTime?
  createdAt    DateTime  @default(now())

  host    User            @relation("RoomHost", fields: [hostId], references: [id])
  players PlayerSession[]
  rounds  Round[]

  @@index([code])
}

enum RoomType {
  PUBLIC
  PRIVATE
}

enum GameState {
  LOBBY
  SHOW_WORD
  WRITE_DEF
  REVEAL_CHOICES
  VOTE
  RESULTS
  END_GAME
}

model PlayerSession {
  id          String    @id @default(cuid())
  roomId      String
  userId      String
  score       Int       @default(0)
  isReady     Boolean   @default(false)
  isConnected Boolean   @default(true)
  socketId    String
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?

  room        Room         @relation(fields: [roomId], references: [id])
  user        User         @relation(fields: [userId], references: [id])
  submissions Submission[]
  votes       Vote[]

  @@unique([roomId, userId])
  @@index([roomId])
}

model Word {
  id           String   @id @default(cuid())
  lemma        String   @unique
  definition   String
  partOfSpeech String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  rounds Round[]

  @@index([lemma])
}

model Round {
  id          String    @id @default(cuid())
  roomId      String
  wordId      String
  roundNumber Int
  startedAt   DateTime  @default(now())
  endedAt     DateTime?

  room        Room         @relation(fields: [roomId], references: [id])
  word        Word         @relation(fields: [wordId], references: [id])
  submissions Submission[]
  votes       Vote[]

  @@unique([roomId, roundNumber])
  @@index([roomId])
}

model Submission {
  id         String   @id @default(cuid())
  roundId    String
  playerId   String?
  userId     String?
  definition String
  isReal     Boolean  @default(false)
  isFlagged  Boolean  @default(false)
  flagReason String?
  createdAt  DateTime @default(now())

  round  Round          @relation(fields: [roundId], references: [id])
  player PlayerSession? @relation(fields: [playerId], references: [id])
  user   User?          @relation(fields: [userId], references: [id])
  votes  Vote[]

  @@index([roundId])
  @@index([playerId])
}

model Vote {
  id           String   @id @default(cuid())
  roundId      String
  playerId     String
  userId       String
  submissionId String
  createdAt    DateTime @default(now())

  round      Round         @relation(fields: [roundId], references: [id])
  player     PlayerSession @relation(fields: [playerId], references: [id])
  user       User          @relation(fields: [userId], references: [id])
  submission Submission    @relation(fields: [submissionId], references: [id])

  @@unique([roundId, playerId])
  @@index([roundId])
}
